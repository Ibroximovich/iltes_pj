<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IELTS Reading Practice Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      html {
        scroll-behavior: smooth;
      }
      .passage-scrollbar::-webkit-scrollbar {
        width: 8px;
      }
      .passage-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }
      .passage-scrollbar::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }
      .passage-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes slideUp {
        from {
          transform: translateY(50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      header {
        height: 80px;
      }
      main {
        margin-top: 100px;
        margin-bottom: 120px;
      }
      #question-nav {
        max-height: 100px;
        overflow-y: auto;
      }
      #result-modal {
        z-index: 100;
      }

      /* Test cards styling */
      .test-card {
        transition: all 0.3s ease;
        cursor: pointer;
      }
      .test-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      }

      /* Password modal */
      .password-modal {
        animation: fadeIn 0.3s ease;
      }
      .password-modal-content {
        animation: slideUp 0.5s ease;
      }

      /* Correct/Incorrect answer highlighting */
      .correct-answer {
        background-color: #d1fae5 !important;
        border-color: #10b981 !important;
        color: #065f46 !important;
      }
      
      .incorrect-answer {
        background-color: #fee2e2 !important;
        border-color: #ef4444 !important;
        color: #991b1b !important;
      }
      
      .correct-radio {
        background-color: #d1fae5 !important;
        border-color: #10b981 !important;
      }
      
      .incorrect-radio {
        background-color: #fee2e2 !important;
        border-color: #ef4444 !important;
      }
      
      .correct-text {
        border: 2px solid #10b981 !important;
        background-color: #d1fae5 !important;
      }
      
      .incorrect-text {
        border: 2px solid #ef4444 !important;
        background-color: #fee2e2 !important;
      }
      
      .show-answer-btn {
        background-color: #3b82f6 !important;
        color: white !important;
        border: none !important;
      }
      
      .show-answer-btn:hover {
        background-color: #2563eb !important;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <!-- Admin Password Modal -->
    <div
      id="admin-password-modal"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4"
    >
      <div
        class="bg-white rounded-xl shadow-2xl max-w-md w-full password-modal-content"
      >
        <div class="p-8">
          <div class="text-center mb-6">
            <div class="text-4xl text-blue-600 mb-4">
              <i class="fas fa-lock"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800">Admin Access</h2>
            <p class="text-gray-600 mt-2">
              Enter admin password to access admin panel
            </p>
          </div>

          <div class="space-y-6">
            <div>
              <label class="block text-gray-700 font-bold mb-2">Password</label>
              <input
                type="password"
                id="admin-login-password"
                class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="Enter admin password"
              />
              <p class="text-gray-500 text-sm mt-2">
                <i class="fas fa-info-circle mr-1"></i>
                Default password: admin123
              </p>
            </div>

            <div
              id="password-error"
              class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg"
            >
              <i class="fas fa-exclamation-triangle mr-2"></i>
              Incorrect password!
            </div>

            <div class="flex space-x-3">
              <button
                onclick="closeAdminModal()"
                class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 rounded-lg transition duration-300"
              >
                Cancel
              </button>
              <button
                onclick="checkAdminPassword()"
                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition duration-300"
              >
                <i class="fas fa-sign-in-alt mr-2"></i>Login
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Fixed Header -->
    <header
      id="main-header"
      class="fixed top-0 left-0 right-0 bg-white shadow-md z-50 p-4 hidden"
    >
      <div class="container mx-auto flex justify-between items-center">
        <h1 class="text-2xl font-bold text-blue-800">
          IELTS Reading Practice Test
        </h1>
        <div class="flex items-center space-x-6">
          <div class="flex items-center space-x-4">
            <div class="text-lg font-semibold">Time:</div>
            <div
              id="timer"
              class="text-2xl font-bold text-red-600 bg-gray-100 px-4 py-2 rounded-lg"
            >
              60:00
            </div>
            <button
              id="pause-timer"
              class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300"
            >
              <i class="fas fa-pause"></i> Pause
            </button>
          </div>
          <button
            id="submit-test"
            class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300"
          >
            <i class="fas fa-paper-plane"></i> Submit Test
          </button>
          <button
            id="back-to-tests"
            class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg"
          >
            ‚Üê Back
          </button>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4">
      <!-- Test Selection Page -->
      <div id="test-selection-page">
        <!-- Header -->
        <div class="text-center mb-12">
          <h1 class="text-4xl font-bold text-blue-800 mb-4">
            üìö IELTS Reading Practice
          </h1>
          <p class="text-gray-600 text-lg max-w-2xl mx-auto">
            Practice with real IELTS reading tests. Improve your skills and
            track your progress.
          </p>
          <div class="mt-8">
            <button
              onclick="openAdminPanel()"
              class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 inline-flex items-center"
            >
              <i class="fas fa-cog mr-2"></i>Admin Panel
            </button>
          </div>
        </div>

        <!-- Test Cards -->
        <div
          id="test-cards-container"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"
        >
          <!-- Tests will be loaded here -->
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="text-center py-12">
          <div
            class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"
          ></div>
          <p class="text-gray-600">Loading tests...</p>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-12">
          <div class="text-6xl text-gray-400 mb-4">üìö</div>
          <h3 class="text-xl font-bold text-gray-600 mb-2">
            No Tests Available
          </h3>
          <p class="text-gray-500 mb-6">Check back later or contact admin.</p>
          <button
            onclick="openAdminPanel()"
            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300"
          >
            <i class="fas fa-cog mr-2"></i>Admin Panel
          </button>
        </div>
      </div>

      <!-- Test Interface Page -->
      <div id="test-interface-page" class="hidden space-y-8 flex">
        <!-- Passage Side -->
        <div class="w-[50%] h-[100vh] overflow-y-auto passage-scrollbar">
          <h3 id="passage-title-display" class="text-2xl font-bold mb-6"></h3>
          <div id="passage-content-display" class="prose max-w-none">
            <!-- Passage will be loaded here -->
          </div>
        </div>

        <!-- Questions Side -->
        <div class="w-[50%] h-[100vh] overflow-y-auto">
          <div id="questions-container">
            <!-- Questions will be loaded here -->
          </div>
        </div>
      </div>
    </main>

    <!-- Question Navigation -->
    <div
      id="question-navigation"
      class="fixed bottom-0 left-0 right-0 bg-white shadow-lg border-t border-gray-200 p-3 z-40 hidden"
    >
      <div class="container mx-auto">
        <div class="flex justify-between items-center mb-2">
          <h3 class="font-bold text-gray-700">Question Navigation</h3>
          <div class="text-gray-600 text-sm">
            <span id="answered-count">0</span>/<span id="total-questions"
              >0</span
            >
            answered
          </div>
        </div>
        <div
          class="flex flex-wrap gap-1 max-h-20 overflow-y-auto"
          id="question-nav"
        >
          <!-- Question numbers will be inserted here -->
        </div>
      </div>
    </div>

    <!-- Result Modal -->
    <div
      id="result-modal"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4"
    >
      <div
        class="bg-white rounded-xl shadow-2xl max-w-4xl w-full"
        style="animation: slideUp 0.5s"
      >
        <div class="p-8">
          <h2 class="text-3xl font-bold text-blue-800 mb-6">Test Results</h2>

          <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-blue-50 p-4 rounded-lg">
              <p class="text-gray-600">Total Questions</p>
              <p
                id="total-questions-result"
                class="text-3xl font-bold text-blue-700"
              >
                0
              </p>
            </div>
            <div class="bg-green-50 p-4 rounded-lg">
              <p class="text-gray-600">Correct Answers</p>
              <p id="correct-answers" class="text-3xl font-bold text-green-700">
                0
              </p>
            </div>
            <div class="bg-yellow-50 p-4 rounded-lg">
              <p class="text-gray-600">Answered Questions</p>
              <p
                id="answered-questions"
                class="text-3xl font-bold text-yellow-700"
              >
                0
              </p>
            </div>
            <div class="bg-red-50 p-4 rounded-lg">
              <p class="text-gray-600">Incorrect Answers</p>
              <p id="incorrect-answers" class="text-3xl font-bold text-red-700">
                0
              </p>
            </div>
          </div>

          <div class="bg-gray-50 p-6 rounded-lg mb-8">
            <h3 class="text-xl font-bold text-gray-700 mb-4">Time Spent</h3>
            <p id="time-spent" class="text-2xl font-bold">00:00</p>
          </div>

          <div class="mb-6">
            <h3 class="text-xl font-bold text-gray-700 mb-4">Detailed Results</h3>
            <div id="detailed-results" class="space-y-4 max-h-80 overflow-y-auto">
              <!-- Detailed results will be shown here -->
            </div>
          </div>

          <div class="flex justify-between">
            <button
              onclick="closeResults()"
              class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition duration-300"
            >
              Close
            </button>
            <button
              onclick="backToTests()"
              class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300"
            >
              Back to Tests
            </button>
            <button
              onclick="reviewAnswers()"
              class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300"
            >
              <i class="fas fa-eye mr-2"></i>Review Answers
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ==================== GLOBAL VARIABLES ====================
      let allTests = [];
      let currentTest = null;
      let timerInterval = null;
      let timeLeft = 60 * 60;
      let timeSpent = 0;
      let isTimerPaused = false;
      let userAnswers = {};
      let questionStates = {};
      let testResults = [];
      let currentTestIndex = -1;

      // ==================== PAGE LOAD ====================
      document.addEventListener("DOMContentLoaded", function () {
        loadTestsFromStorage();
        displayTestCards();
        
        // Check if user was in the middle of a test
        const savedTestProgress = localStorage.getItem('ielts_test_progress');
        if (savedTestProgress) {
          const progress = JSON.parse(savedTestProgress);
          if (progress.testIndex !== undefined && progress.userAnswers) {
            const confirmRestore = confirm("You have an unfinished test. Would you like to continue where you left off?");
            if (confirmRestore) {
              startTest(progress.testIndex);
              // Restore previous answers
              setTimeout(() => {
                restoreAnswers(progress.userAnswers);
              }, 500);
            } else {
              // Clear saved progress
              localStorage.removeItem('ielts_test_progress');
            }
          }
        }
      });

      // ==================== ADMIN ACCESS ====================
      function openAdminPanel() {
        document
          .getElementById("admin-password-modal")
          .classList.remove("hidden");
        document.getElementById("admin-password-modal").classList.add("flex");
      }

      function closeAdminModal() {
        document.getElementById("admin-password-modal").classList.add("hidden");
        document.getElementById("admin-login-password").value = "";
        document.getElementById("password-error").classList.add("hidden");
      }

      function checkAdminPassword() {
        const password = document.getElementById("admin-login-password").value;
        const savedPassword =
          localStorage.getItem("ielts_admin_password") || "admin123";

        if (password === savedPassword) {
          localStorage.setItem("ielts_is_admin", "true");
          window.open("admin-panel.html", "_blank");
          closeAdminModal();
        } else {
          document.getElementById("password-error").classList.remove("hidden");
          document.getElementById("admin-login-password").value = "";
        }
      }

      // ==================== TEST SELECTION ====================
      function loadTestsFromStorage() {
        try {
          const savedTests = localStorage.getItem("ielts_tests");
          allTests = savedTests ? JSON.parse(savedTests) : [];
        } catch (error) {
          allTests = [];
        }
      }

      function displayTestCards() {
        const container = document.getElementById("test-cards-container");
        const loading = document.getElementById("loading-state");
        const empty = document.getElementById("empty-state");

        loading.classList.remove("hidden");
        empty.classList.add("hidden");
        container.innerHTML = "";

        setTimeout(() => {
          loading.classList.add("hidden");

          if (allTests.length === 0) {
            empty.classList.remove("hidden");
            return;
          }

          container.innerHTML = allTests
            .map(
              (test, index) => `
                    <div class="test-card bg-white rounded-xl shadow-lg p-6" onclick="startTest(${index})">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-blue-700 mb-2">${
                                  test.title || "IELTS Test"
                                }</h3>
                                <p class="text-gray-600 text-sm mb-3">${
                                  test.passage?.title || "Reading Passage"
                                }</p>
                            </div>
                            <span class="px-3 py-1 text-xs font-bold rounded-full bg-blue-100 text-blue-800">
                                ${test.questions?.length || 0} Q
                            </span>
                        </div>
                        
                        <div class="flex items-center text-gray-500 text-sm mb-4">
                            <i class="fas fa-clock mr-2"></i>
                            <span>${test.duration || 60} minutes</span>
                        </div>
                        
                        <div class="flex justify-between items-center">
                            <div class="text-sm text-gray-500">
                                <i class="fas fa-calendar mr-1"></i>
                                ${new Date(
                                  parseInt(test.id)
                                ).toLocaleDateString()}
                            </div>
                            <button class="text-blue-600 hover:text-blue-800 font-medium flex items-center">
                                Start Test <i class="fas fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                `
            )
            .join("");
        }, 800);
      }

      // ==================== TEST INTERFACE ====================
      function startTest(testIndex) {
        currentTestIndex = testIndex;
        currentTest = allTests[testIndex];

        // Show test interface
        document.getElementById("test-selection-page").classList.add("hidden");
        document
          .getElementById("test-interface-page")
          .classList.remove("hidden");
        document.getElementById("main-header").classList.remove("hidden");
        document
          .getElementById("question-navigation")
          .classList.remove("hidden");

        // Display passage
        document.getElementById("passage-title-display").textContent =
          currentTest.passage?.title || "Reading Passage";
        document.getElementById("passage-content-display").innerHTML =
          currentTest.passage?.content || "";

        // Display questions
        displayQuestions();

        // Setup timer
        timeLeft = (currentTest.duration || 60) * 60;
        timeSpent = 0;
        isTimerPaused = false;
        startTimer();

        // Initialize answers
        userAnswers = {};
        questionStates = {};

        // Setup navigation
        setupQuestionNavigation();

        // Scroll to top
        window.scrollTo({ top: 0, behavior: "smooth" });

        // Auto-save progress every 10 seconds
        setInterval(() => {
          if (currentTest) {
            saveTestProgress();
          }
        }, 10000);
      }

      function saveTestProgress() {
        const progress = {
          testIndex: currentTestIndex,
          userAnswers: userAnswers,
          timeLeft: timeLeft,
          timestamp: new Date().toISOString()
        };
        localStorage.setItem('ielts_test_progress', JSON.stringify(progress));
      }

      function restoreAnswers(savedAnswers) {
        if (!savedAnswers) return;
        
        userAnswers = { ...savedAnswers };
        
        // Update UI with saved answers
        Object.entries(savedAnswers).forEach(([questionNum, answer]) => {
          const questionNumInt = parseInt(questionNum);
          
          // For radio buttons
          const radioInput = document.querySelector(`input[name="q${questionNumInt}"][value="${answer}"]`);
          if (radioInput) {
            radioInput.checked = true;
            updateQuestionState(questionNumInt, "answered");
          }
          
          // For text inputs
          const textInput = document.querySelector(`input[type="text"][data-question="${questionNumInt}"]`);
          if (textInput) {
            textInput.value = answer;
            updateQuestionState(questionNumInt, "answered");
          }
        });
        
        updateAnsweredCount();
      }

      function displayQuestions() {
        const container = document.getElementById("questions-container");
        container.innerHTML = "";

        if (!currentTest.questions || currentTest.questions.length === 0) {
          container.innerHTML =
            '<p class="text-gray-500 p-6">No questions available.</p>';
          return;
        }

        // Group questions by sections
        let currentSection = 1;
        let sectionStart = 1;
        let sectionHTML = "";

        currentTest.questions.forEach((question, index) => {
          if (index === 0 || question.number === 1) {
            if (sectionHTML) {
              container.innerHTML += sectionHTML;
            }
            const sectionEnd = Math.min(
              question.number + 5,
              currentTest.questions.length
            );
            sectionHTML = `
                        <section class="bg-white p-6 rounded-xl shadow-lg mb-6">
                            <h3 class="text-xl font-bold text-blue-700 mb-6">Questions ${question.number}-${sectionEnd}</h3>
                            <div class="space-y-6">
                    `;
            sectionStart = question.number;
          }

          // Add question
          sectionHTML += generateQuestionHTML(question);

          // Close section if last question or next starts new section
          if (
            index === currentTest.questions.length - 1 ||
            currentTest.questions[index + 1]?.number === 1
          ) {
            sectionHTML += `
                            </div>
                        </section>
                    `;
            container.innerHTML += sectionHTML;
          }
        });

        // Add event listeners
        document.querySelectorAll(".answer-input").forEach((input) => {
          input.addEventListener("change", saveUserAnswer);
          if (input.type === "text") {
            input.addEventListener("input", saveUserAnswer);
          }
        });
      }

      function generateQuestionHTML(question) {
        if (!question) return "";

        switch (question.type) {
          case "short-answer":
          case "sentence-completion":
            return `
                        <div class="question-group" data-question="${question.number}">
                            <p class="mb-2 font-medium"><strong>${question.number}.</strong> ${question.text}</p>
                            <input type="text" class="answer-input w-full border border-gray-300 rounded p-3 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none" 
                                   data-question="${question.number}" placeholder="Type your answer here...">
                            <div class="correct-answer-display mt-2 hidden">
                                <small class="text-green-600 font-medium"><i class="fas fa-check-circle mr-1"></i>Correct answer: <span class="correct-value"></span></small>
                            </div>
                        </div>
                    `;

          case "true-false-notgiven":
            return `
                        <div class="question-group" data-question="${question.number}">
                            <p class="mb-2 font-medium"><strong>${question.number}.</strong> ${question.text}</p>
                            <div class="grid grid-cols-3 gap-5">
                                <label class="flex items-center p-3 border border-gray-300 rounded-lg hover:bg-gray-50 cursor-pointer answer-label" data-value="TRUE">
                                    <input type="radio" name="q${question.number}" value="TRUE" 
                                           class="mr-3 h-5 w-5 answer-input" data-question="${question.number}">
                                    <span>TRUE</span>
                                </label>
                                <label class="flex items-center p-3 border border-gray-300 rounded-lg hover:bg-gray-50 cursor-pointer answer-label" data-value="FALSE">
                                    <input type="radio" name="q${question.number}" value="FALSE" 
                                           class="mr-3 h-5 w-5 answer-input" data-question="${question.number}">
                                    <span>FALSE</span>
                                </label>
                                <label class="flex items-center p-3 border border-gray-300 rounded-lg hover:bg-gray-50 cursor-pointer answer-label" data-value="NOT GIVEN">
                                    <input type="radio" name="q${question.number}" value="NOT GIVEN" 
                                           class="mr-3 h-5 w-5 answer-input" data-question="${question.number}">
                                    <span>NOT GIVEN</span>
                                </label>
                            </div>
                            <div class="correct-answer-display mt-2 hidden">
                                <small class="text-green-600 font-medium"><i class="fas fa-check-circle mr-1"></i>Correct answer: <span class="correct-value"></span></small>
                            </div>
                        </div>
                    `;

          case "multiple-choice":
            let optionsHTML = "";
            if (question.options) {
              Object.entries(question.options).forEach(([letter, text]) => {
                optionsHTML += `
                                <label class="flex items-center p-3 border border-gray-300 rounded-lg hover:bg-gray-50 cursor-pointer answer-label" data-value="${letter}">
                                    <input type="radio" name="q${question.number}" value="${letter}" 
                                           class="mr-3 h-5 w-5 answer-input" data-question="${question.number}">
                                    <span>${letter}. ${text}</span>
                                </label>
                            `;
              });
            }

            return `
                        <div class="question-group" data-question="${question.number}">
                            <p class="mb-2 font-medium"><strong>${question.number}.</strong> ${question.text}</p>
                            <div class="space-y-3">
                                ${optionsHTML}
                            </div>
                            <div class="correct-answer-display mt-2 hidden">
                                <small class="text-green-600 font-medium"><i class="fas fa-check-circle mr-1"></i>Correct answer: <span class="correct-value"></span></small>
                            </div>
                        </div>
                    `;

          default:
            return `
                        <div class="question-group" data-question="${question.number}">
                            <p class="mb-2 font-medium"><strong>${question.number}.</strong> ${question.text}</p>
                            <input type="text" class="answer-input w-full border border-gray-300 rounded p-3 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none" 
                                   data-question="${question.number}" placeholder="Type your answer here...">
                            <div class="correct-answer-display mt-2 hidden">
                                <small class="text-green-600 font-medium"><i class="fas fa-check-circle mr-1"></i>Correct answer: <span class="correct-value"></span></small>
                            </div>
                        </div>
                    `;
        }
      }

      // ==================== TIMER FUNCTIONS ====================
      function startTimer() {
        if (timerInterval) clearInterval(timerInterval);

        timerInterval = setInterval(() => {
          if (!isTimerPaused) {
            timeLeft--;
            timeSpent++;

            if (timeLeft <= 0) {
              clearInterval(timerInterval);
              submitTest();
              return;
            }

            updateTimerDisplay();
          }
        }, 1000);

        updateTimerDisplay();
      }

      function updateTimerDisplay() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        document.getElementById("timer").textContent = `${minutes
          .toString()
          .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
      }

      // ==================== ANSWER HANDLING ====================
      function saveUserAnswer(event) {
        const questionNum = parseInt(event.target.dataset.question);

        if (event.target.type === "radio") {
          userAnswers[questionNum] = event.target.value;
        } else if (event.target.type === "text") {
          userAnswers[questionNum] = event.target.value.trim().toLowerCase();
        }

        updateQuestionState(questionNum, "answered");
        updateAnsweredCount();
        
        // Save progress
        saveTestProgress();
      }

      function updateQuestionState(questionNum, state) {
        const button = document.querySelector(
          `.question-nav-btn[data-question="${questionNum}"]`
        );
        if (!button) return;

        button.classList.remove("bg-white", "bg-blue-500", "bg-green-500", "bg-red-500");

        if (state === "answered") {
          button.classList.add("bg-blue-500", "text-white");
          questionStates[questionNum] = "answered";
        } else if (state === "correct") {
          button.classList.add("bg-green-500", "text-white");
        } else if (state === "incorrect") {
          button.classList.add("bg-red-500", "text-white");
        }
      }

      function updateAnsweredCount() {
        const answeredCount = Object.values(questionStates).filter(
          (state) => state === "answered"
        ).length;
        const totalQuestions = currentTest?.questions?.length || 0;

        document.getElementById("answered-count").textContent = answeredCount;
        document.getElementById("total-questions").textContent = totalQuestions;
        document.getElementById("answered-questions").textContent =
          answeredCount;
      }

      function setupQuestionNavigation() {
        const navContainer = document.getElementById("question-nav");
        navContainer.innerHTML = "";

        if (!currentTest.questions) return;

        currentTest.questions.forEach((question) => {
          const button = document.createElement("button");
          button.className =
            "question-nav-btn w-8 h-8 rounded-full border border-gray-300 bg-white text-gray-700 hover:bg-gray-100";
          button.textContent = question.number;
          button.dataset.question = question.number;
          button.onclick = () => scrollToQuestion(question.number);
          navContainer.appendChild(button);
        });

        updateAnsweredCount();
      }

      function scrollToQuestion(questionNumber) {
        const questionElement = document.querySelector(
          `[data-question="${questionNumber}"]`
        );
        if (questionElement) {
          questionElement.scrollIntoView({
            behavior: "smooth",
            block: "center",
          });
        }
      }

      // ==================== TEST SUBMISSION ====================
      function submitTest() {
        if (timerInterval) clearInterval(timerInterval);

        // Clear saved progress
        localStorage.removeItem('ielts_test_progress');

        // Disable inputs
        document.querySelectorAll(".answer-input").forEach((input) => {
          input.disabled = true;
        });

        // Calculate results
        let correctCount = 0;
        let totalQuestions = currentTest.questions?.length || 0;
        testResults = [];

        if (currentTest.correctAnswers) {
          currentTest.questions?.forEach((question) => {
            const userAnswer = userAnswers[question.number];
            const correctAnswer = currentTest.correctAnswers[question.number];
            let isCorrect = false;

            if (userAnswer && correctAnswer) {
              isCorrect =
                userAnswer.toString().toLowerCase() ===
                correctAnswer.toString().toLowerCase();
              if (isCorrect) correctCount++;

              // Save result
              testResults.push({
                questionNumber: question.number,
                userAnswer: userAnswer,
                correctAnswer: correctAnswer,
                isCorrect: isCorrect,
                questionText: question.text
              });

              // Update navigation button color
              updateQuestionState(question.number, isCorrect ? "correct" : "incorrect");
            }
          });
        }

        // Show results modal
        showResults(correctCount, totalQuestions);
      }

      function showResults(correctCount, totalQuestions) {
        document.getElementById("total-questions-result").textContent =
          totalQuestions;
        document.getElementById("correct-answers").textContent = correctCount;
        document.getElementById("incorrect-answers").textContent =
          totalQuestions - correctCount;

        // Format time spent
        const minutesSpent = Math.floor(timeSpent / 60);
        const secondsSpent = timeSpent % 60;
        document.getElementById("time-spent").textContent = `${minutesSpent
          .toString()
          .padStart(2, "0")}:${secondsSpent.toString().padStart(2, "0")}`;

        // Show detailed results
        showDetailedResults();

        // Show modal
        document.getElementById("result-modal").classList.remove("hidden");
        document.getElementById("result-modal").classList.add("flex");
      }

      function showDetailedResults() {
        const container = document.getElementById("detailed-results");
        container.innerHTML = "";

        testResults.forEach(result => {
          const resultElement = document.createElement("div");
          resultElement.className = `p-4 rounded-lg ${result.isCorrect ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}`;
          
          resultElement.innerHTML = `
            <div class="flex justify-between items-start">
              <div>
                <h4 class="font-bold ${result.isCorrect ? 'text-green-800' : 'text-red-800'}">
                  Question ${result.questionNumber}
                </h4>
                <p class="text-gray-600 text-sm mt-1">${result.questionText}</p>
              </div>
              <span class="px-3 py-1 rounded-full text-sm font-bold ${result.isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                ${result.isCorrect ? '‚úì Correct' : '‚úó Incorrect'}
              </span>
            </div>
            <div class="mt-3 grid grid-cols-2 gap-4">
              <div>
                <p class="text-sm text-gray-500">Your Answer</p>
                <p class="font-medium ${result.isCorrect ? 'text-green-700' : 'text-red-700'}">${result.userAnswer || 'Not answered'}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500">Correct Answer</p>
                <p class="font-medium text-green-700">${result.correctAnswer}</p>
              </div>
            </div>
          `;
          
          container.appendChild(resultElement);
        });
      }

      function reviewAnswers() {
        closeResults();
        
        // Show correct answers for each question
        currentTest.questions?.forEach(question => {
          const questionDiv = document.querySelector(`[data-question="${question.number}"]`);
          if (!questionDiv) return;
          
          const correctAnswer = currentTest.correctAnswers[question.number];
          const userAnswer = userAnswers[question.number];
          
          // Show correct answer display
          const correctAnswerDisplay = questionDiv.querySelector('.correct-answer-display');
          const correctValueSpan = questionDiv.querySelector('.correct-value');
          
          if (correctAnswerDisplay && correctValueSpan) {
            correctAnswerDisplay.classList.remove('hidden');
            correctValueSpan.textContent = correctAnswer;
          }
          
          // Highlight user's answer
          highlightUserAnswer(question.number, userAnswer, correctAnswer);
        });
      }

      function highlightUserAnswer(questionNumber, userAnswer, correctAnswer) {
        const questionDiv = document.querySelector(`[data-question="${questionNumber}"]`);
        if (!questionDiv) return;
        
        // For radio button questions
        const answerLabels = questionDiv.querySelectorAll('.answer-label');
        answerLabels.forEach(label => {
          const value = label.getAttribute('data-value');
          if (value === userAnswer) {
            if (userAnswer === correctAnswer) {
              label.classList.add('correct-radio');
            } else {
              label.classList.add('incorrect-radio');
            }
          }
          
          // Highlight correct answer if user got it wrong
          if (value === correctAnswer && userAnswer !== correctAnswer) {
            label.classList.add('correct-answer');
          }
        });
        
        // For text input questions
        const textInput = questionDiv.querySelector('input[type="text"]');
        if (textInput) {
          if (userAnswer === correctAnswer) {
            textInput.classList.add('correct-text');
          } else {
            textInput.classList.add('incorrect-text');
          }
        }
      }

      function closeResults() {
        document.getElementById("result-modal").classList.add("hidden");
      }

      function backToTests() {
        // Clear saved progress
        localStorage.removeItem('ielts_test_progress');
        
        closeResults();
        document.getElementById("test-interface-page").classList.add("hidden");
        document
          .getElementById("test-selection-page")
          .classList.remove("hidden");
        document.getElementById("main-header").classList.add("hidden");
        document.getElementById("question-navigation").classList.add("hidden");

        // Refresh tests list
        loadTestsFromStorage();
        displayTestCards();
      }

      // ==================== EVENT LISTENERS ====================
      document.getElementById("pause-timer").addEventListener("click", function () {
        isTimerPaused = !isTimerPaused;

        if (isTimerPaused) {
          this.innerHTML = '<i class="fas fa-play"></i> Resume';
        } else {
          this.innerHTML = '<i class="fas fa-pause"></i> Pause';
        }
      });
      
      document.getElementById("submit-test").addEventListener("click", function () {
        const confirmSubmit = confirm("Are you sure you want to submit the test?");
        if (confirmSubmit) {
          submitTest();
        }
      });

      document.getElementById("back-to-tests").addEventListener("click", function () {
        const confirmLeave = confirm("Leave the test? Your progress will be saved.");
        if (confirmLeave) {
          saveTestProgress();
          
          if (timerInterval) clearInterval(timerInterval);
          
          document.getElementById('test-interface-page').classList.add('hidden');
          document.getElementById('test-selection-page').classList.remove('hidden');
          document.getElementById('main-header').classList.add('hidden');
          document.getElementById('question-navigation').classList.add('hidden');

          loadTestsFromStorage();
          displayTestCards();
        }
      });

      // ==================== AUTO REFRESH ====================
      // Check for new tests every 3 seconds
      setInterval(() => {
        loadTestsFromStorage();
        if (
          document
            .getElementById("test-selection-page")
            .classList.contains("hidden") === false
        ) {
          displayTestCards();
        }
      }, 3000);

      // ==================== PAGE UNLOAD HANDLER ====================
      window.addEventListener('beforeunload', function (e) {
        if (currentTest) {
          saveTestProgress();
          // Show confirmation dialog
          e.preventDefault();
          e.returnValue = 'Your test progress will be saved. Are you sure you want to leave?';
        }
      });
    </script>
  </body>
</html>